# ITEM48) 스트림 병렬화는 주의해서 사용하라

## 1. 자바로 동시성 프로그램 작성 쉽도록 계속 지원하는 중

- 스레드, 동기화, wait/notify 지원 (1996)
- 동시성 컬렉션 java.util.concurrent 라이브러리와 실행자(Executor) 프레임워크 지원
- 고성능 병렬 분해(Parallel decom-position) 프레임워크인 포크-조인 패키지 추가 (자바7)
- parallel 메서드 스트림 지원 (자바 8)

→ 여전히 어렵고, 안정성(safety)과 응답 가능(liveness) 상태를 유지하기 위해 애써야 한다.

## 2.  병렬화를 사용한 성능 개선

- 성능 개선 없음 → 스트림 라이브러리가 파이프라인을 병렬화하는 방법을 찾지 못해서
    
    데이터 소스가 Stream.iterate거나 중간 연산으로 limit를 쓰면 파이프라인 병렬화로는 성능 개선을 기대할 수 없음
    
- 스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap의 인스턴스거나 배열, int 범위, long 범위일 때 병렬화의 효과가 가장 좋다.
    
    → 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 일을 다수의 스레드에 분해하기 좋음
    
    - 나누는 작업은 Spliterator가 담당 → Stream이나 Iterable의 spliterator메서드로 얻을 수 있음
    - 원소들을 순차적으로 실행할 때의 참조 지역성(locality of reference)이 뛰어남
        
        → 이웃한 참조들이 메모리에 연속해서 저장되어 있음
        
    - 참조 지역성은 다량의 데이터를 처리하는 벌크 연산을 병렬화할 때 아주 중요한 요소로 작용한다.
    - 참조 지역성이 가장 뛰어난 자료구조는 기본 타입의  배열 → 데이터 자체가 메모리에 연속해서 저장되기 떄문
- Stream, Iterable, Collection 병렬화 이점 제대로 하려면 → spliterator 메서드를 재정의하고 결과 스트림의 병렬화 성능을 강도 높게 테스트해라.
- 스트림을 잘못 병렬화하면 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있음.  = 안전실패(safety failure)

** 실제로 성능향상 추정 방법 : 스트림 안의 원소 수와 원소당 수행되는 코드 줄 수를 곱해보자.

→ 이 값이 최소 수십만은 되어야 성능 향상을 맛볼 수 있음

- 스트림 병렬화는 오직 성능 최적화 수단임 → 반드시 성능 테스트해서 가치가 있는지 판단
- 잘못된 파이프라인 하나가 시스템의 다른 부분의 성능에까지 악영향을 줄 수 있음
- 조건이 잘 갖춰지면 parallel 메서드 호출 하나로 거의 프로세서 코어 수에 비례하는 성능 향상을 만끽할 수 있다.